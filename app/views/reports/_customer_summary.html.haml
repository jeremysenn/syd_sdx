%p.lead Customer Summary Report
-# @tickets.group_by{ |t| t['Company']}.each_with_index do |(ticket_group, tickets), index|
- @tickets.group_by{ |t| "#{t['FirstName']} #{t['LastName']}"}.each_with_index do |(ticket_group, tickets), index|
  %div.panel.panel-default
    %div.panel-heading
      %h3.panel-title
        %a.group{"aria-controls" => "collapse#{index}", "aria-expanded" => "true", "data-toggle" => "collapse", :href => "#collapse#{index}", :role => "button"}
          = ticket_group
          = "No name" if ticket_group.blank?
          #details.text-muted.pull-right
            = number_to_currency(tickets.map { |t| Ticket.line_items_total(t['TicketItemCollection']['ApiTicketItem']).to_d }.sum)
    %div.panel-collapse.collapse.in{:id => "collapse#{index}", "aria-labelledby" => "headingOne", :role => "tabpanel"}
      %table.table.table-striped.table-responsive
        %thead
          %tr
            %td 
              %strong Date
            %td 
              %strong Ticket
            %td 
              %strong Amount
            - unless @status == '1' # Don't show for closed tickets
              %td 
                %strong Method
            -#
              %td
                %strong Ticket record
        %tbody
          - tickets.each do |ticket|
            %tr
              %td= ticket["DateClosed"].to_date.strftime("%m/%d/%y")
              %td
                = link_to ticket["TicketNumber"], ticket_path(ticket['Id'], status: ticket['Status'])
                =# ticket["TicketNumber"]
              %td
                = number_to_currency(Ticket.line_items_total(ticket['TicketItemCollection']['ApiTicketItem']))
                =# "(#{payment_method_string(AccountsPayable.all(current_user.token, current_yard_id, ticket['Id']).last['PaymentMethod'])})"
              - unless @status == '1'  # Don't show for closed tickets
                %td
                  = "#{payment_method_string(AccountsPayable.all(current_user.token, current_yard_id, ticket['Id']).find{|accounts_payable| accounts_payable['PaymentStatus'] == '1'}['PaymentMethod'])}" 
              -# %td= ticket
          -#
            %tr
              %td
              %td
              %td
                %strong= number_to_currency(tickets.map { |t| Ticket.line_items_total(t['TicketItemCollection']['ApiTicketItem']).to_d }.sum)
.pull-right
  %p.lead
    Cash
    = number_to_currency(@cash_payment_tickets.map { |t| Ticket.line_items_total(t['TicketItemCollection']['ApiTicketItem']).to_d }.sum)
    %br
    Check
    = number_to_currency(@check_payment_tickets.map { |t| Ticket.line_items_total(t['TicketItemCollection']['ApiTicketItem']).to_d }.sum)
    %br
    %strong Total
    = number_to_currency(@line_items_total)