%p.lead 
  Shipments Customer Summary Report
  - unless @pack_shipments.blank? 
    %a{href: reports_path(format: "csv", 'report[type]' => @type, 'report[status]' => @status, 'report[start_date]' => @start_date, 'report[end_date]' => @end_date), class: 'btn btn-default'}
      %i.fa.fa-download
      CSV

- @pack_shipments.group_by{ |ps| "#{ps['CustomerName']}"}.each_with_index do |(pack_shipment_group, pack_shipments), index|
  %div.panel.panel-default
    %div.panel-heading
      %h3.panel-title
        %a.group{"aria-controls" => "collapse#{index}", "aria-expanded" => "true", "data-toggle" => "collapse", :href => "#collapse#{index}", :role => "button"}
          = pack_shipment_group
          = "No name" if pack_shipment_group.blank?
          #details.text-muted.pull-right
            =# number_to_currency(tickets.map { |t| Ticket.line_items_total(t['TicketItemCollection']['ApiTicketItem']).to_d }.sum)
    %div.panel-collapse.collapse.in{:id => "collapse#{index}", "aria-labelledby" => "headingOne", :role => "tabpanel"}
      %table.table.table-striped.table-responsive.table-hover{"data-provides" => "rowlink"}
        %thead
          %tr
            %th Date
            %th Shipment
            %th Description
            %th Net
            -#
              %th Details
        %tbody
          - pack_shipments.sort_by{|pack_shipment| pack_shipment['DateShipped']}.reverse.each do |pack_shipment|
            %tr
              %td= pack_shipment['DateShipped'].to_date.strftime("%m/%d/%y")
              %td= link_to pack_shipment['ShipmentNumber'], pack_shipment_path(pack_shipment['Id'])
              %td= pack_shipment['ContractDescription']
              %td= "#{pack_shipment['NetWeight'].to_d.round(3)} #{pack_shipment['UnitOfMeasure']}"
          %tr
            %td
            %td
            %td
            %td
              %strong= "#{pack_shipments.map { |ps| ps['NetWeight'].to_d }.sum.round(3)}"
-#
  - @pack_shipments.group_by{ |t| "#{t['FirstName']} #{t['LastName']}"}.each_with_index do |(ticket_group, tickets), index|
    %div.panel.panel-default
      %div.panel-heading
        %h3.panel-title
          %a.group{"aria-controls" => "collapse#{index}", "aria-expanded" => "true", "data-toggle" => "collapse", :href => "#collapse#{index}", :role => "button"}
            = ticket_group
            = "No name" if ticket_group.blank?
            #details.text-muted.pull-right
              = number_to_currency(tickets.map { |t| Ticket.line_items_total(t['TicketItemCollection']['ApiTicketItem']).to_d }.sum)
      %div.panel-collapse.collapse.in{:id => "collapse#{index}", "aria-labelledby" => "headingOne", :role => "tabpanel"}
        %table.table.table-striped.table-responsive.table-hover{"data-provides" => "rowlink"}
          %thead
            %tr
              %th
                Date
              %th
                Ticket
              %th
                Amount
              - unless @status == '1' # Don't show for closed tickets
                %th
                  Method
              -#
                %td
                  %strong Ticket record
          %tbody
            - tickets.each do |ticket|
              %tr
                %td= ticket["DateClosed"].to_date.strftime("%m/%d/%y")
                %td
                  = link_to ticket["TicketNumber"], ticket_path(ticket['Id'], status: ticket['Status'])
                  =# ticket["TicketNumber"]
                %td
                  = number_to_currency(Ticket.line_items_total(ticket['TicketItemCollection']['ApiTicketItem']))
                  =# "(#{payment_method_string(AccountsPayable.all(current_user.token, current_yard_id, ticket['Id']).last['PaymentMethod'])})"
                - unless @status == '1'  # Don't show for closed tickets
                  %td
                    = "#{payment_method_string(AccountsPayable.all(current_user.token, current_yard_id, ticket['Id']).find{|accounts_payable| accounts_payable['PaymentStatus'] == '1'}['PaymentMethod'])}" 
                -# %td= ticket
            -#
              %tr
                %td
                %td
                %td
                  %strong= number_to_currency(tickets.map { |t| Ticket.line_items_total(t['TicketItemCollection']['ApiTicketItem']).to_d }.sum)
  .pull-right
    %p.lead
      %strong Total
      = number_to_currency(@line_items_total)