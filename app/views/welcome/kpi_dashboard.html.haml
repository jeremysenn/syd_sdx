= render 'shared/navbars/kpi_dashboard_navbar'

.jumbotron{id: 'kpi_dashboard', style: 'background-color: black;'}
  .container-fluid
    .row
      .col-xs-12
        .col-xs-12.col-sm-3{style: 'color: white;'}
          %h3.text-center
            - unless current_user.company.logo.url.blank?
              = image_tag(current_user.company.logo.url(:thumb), class: 'img-responsive center-block', size: '150x150')
            POWERED BY 
            %br
            %span.text-info SCRAP DRAGON
            
        .col-xs-12.col-sm-4
          %iframe{:frameborder => "0", :seamless => "", :src => "https://www.zeitverschiebung.net/clock-widget-iframe-v2?language=en&size=large&timezone=#{url_encode(session[:time_zone])}", :width => "100%"}
          .text-center
            = form_tag scoreboard_path, method: 'get', :class => "form-inline", role: 'search' do
              %p= select_tag :yard_id, options_for_select(@yards.collect {|yard| [ yard['Name'], yard['Id'] ] }, current_yard_id), class: "form-control", onchange: "this.form.submit();"
          
          -#
            .panel{style: 'background-color: #303030; color: white; height: 150px; padding-top: 0px; padding-bottom: 0px;'}
              -#
                .panel-heading{style: 'background-color: gray;'}
                  New York
              .panel-body
                %iframe{:frameborder => "0", :seamless => "", :src => "https://www.zeitverschiebung.net/clock-widget-iframe-v2?language=en&size=large&timezone=America%2FNew_York", :width => "100%"}
                %h4.text-center
                  %i.fa.fa-warning
                  System wide alert
        .col-xs-12.col-sm-5
          .panel
            .panel-heading
              -# %iframe#forecast_embed{:frameborder => "0", :height => "210", :src => "//forecast.io/embed/#lat=#{current_user.company.latitude}&lon=#{current_user.company.longitude}&color=#00aaff&name=#{current_user.company.city.blank? ? 'St. Pete' : current_user.company.city}", :width => "100%"}
              %iframe#forecast_embed{:frameborder => "0", :height => "140", :src => "//forecast.io/embed/#lat=#{current_user.company.latitude}&lon=#{current_user.company.longitude}&color=#00aaff&name=#{current_user.company.city.blank? ? 'St. Pete' : current_user.company.city}", :width => "100%"}
              -#
                %h2.text-center
                  %i.fa.fa-cloud
                  Weather
                #weather{'data-zipcode' => "#{current_user.company.zip.blank? ? '33710' : current_user.company.zip}", style: 'background-color: #303030; color: white;'}
        -#
          .pull-right
            .col-xs-12.col-sm-2
              = form_tag welcome_kpi_dashboard_path, method: 'get', :class => "form-inline", role: 'search' do
                %p= select_tag :yard_id, options_for_select(@yards.collect {|yard| [ yard['Name'], yard['Id'] ] }, current_yard_id), class: "form-control input-lg", onchange: "this.form.submit();"
    .row
      .col-xs-12
        .col-xs-6
          .col-xs-12.col-sm-4
            .panel{style: 'background-color: #303030; color: white;'}
              .panel-heading
                %h2.text-center Created
                %h3.text-center
                  Today:
                  %span.text-info= "#{@tickets_today.blank? ? 0 : @tickets_today}"
                  %br
                  30-Day:
                  %span.text-info= "#{@tickets_30_days.blank? ? 0 : @tickets_30_days}"
                  =# Commodity.types(current_user.token, current_yard_id)
                  =# Commodity.find_by_id(current_user.token, current_yard_id, Ticket.line_items(@closed_and_held_and_paid_tickets.last['TicketItemCollection']['ApiTicketItem']).first["CommodityId"])
          .col-xs-12.col-sm-4
            .panel{style: 'background-color: #303030; color: white;'}
              .panel-heading
                %h2.text-center Held
                %h3.text-center
                  Total:
                  %span.text-info= "#{@tickets_on_hold_total.blank? ? 0 : @tickets_on_hold_total}"
                  %br
                  Avg:
                  %span.text-info= "#{@average_hold_time.blank? ? 0 : @average_hold_time} min"
          .col-xs-12.col-sm-4
            .panel{style: 'background-color: #303030; color: white;'}
              .panel-heading
                %h2.text-center Paid
                %h3.text-center
                  Today:
                  %span.text-info= "#{@paid_tickets_today_count.blank? ? 0 : @paid_tickets_today_count}"
                  %br
                  Total:
                  %span.text-info= number_to_currency(@paid_tickets_today_amount.blank? ? 0 : @paid_tickets_today_amount)
          - @commodity_totals_by_type.each do |commodity_total|
            .col-xs-12.col-sm-4
              .panel{style: 'background-color: #303030; color: white;'}
                .panel-heading
                  %h2.text-center= commodity_total['ReportDescription']
                .table-responsive
                  %table.table.table-condensed
                    %tr
                      %td Today
                      %td= "#{number_with_delimiter(commodity_total['Weight'].to_i.round)}lb"
                      %td= "#{number_to_currency(commodity_total['Cost'].to_i.round, precision: 0)}"
                    %tr
                      %td 30-Day
                      %td= "#{number_with_delimiter(commodity_total['MultiDayWeightAverage'].to_i.round)}lb"
                      %td= "#{number_to_currency(commodity_total['MultiDayCostAverage'].to_i.round, precision: 0)}"
                  -#
                    %h3.text-center
                      Today:
                      %span.text-info
                        = "#{number_with_delimiter(commodity_total['Weight'].to_i.round)}lb (#{number_to_currency(commodity_total['Cost'].to_i.round)})"
                      %br
                      30-Day:
                      %span.text-info
                        = "#{number_with_delimiter(commodity_total['MultiDayWeightAverage'].to_i.round)}lb (#{number_to_currency(commodity_total['MultiDayCostAverage'].to_i.round)})"
          .col-xs-12.col-sm-6
            .panel{style: 'background-color: #303030; color: white;'}
              .panel-heading
                %h2.text-center Held Shipments
                %h3.text-center
                  Today:
                  %span.text-info= "#{@held_shipments_count}"
                  - unless @held_shipments_count.blank? or @held_shipments_count == '0' or @held_shipment.blank?
                    %br
                    %span.text-info= @held_shipment['CustomerName'] 
                    %br
                    %span.text-info= @held_shipment['DateCreated'].to_datetime.in_time_zone(session[:time_zone]).strftime("%l:%M %p") unless @held_shipment['DateCreated'].blank? or @held_shipment['DateCreated'] == '{"i:nil"=>"true"}'
          .col-xs-12.col-sm-6
            .panel{style: 'background-color: #303030; color: white;'}
              .panel-heading
                %h2.text-center Sent Shipments
                %h3.text-center
                  Today:
                  %span.text-info= "#{@sent_shipments_count}"
                  - unless @sent_shipments_count.blank? or @sent_shipments_count == '0' or @closed_shipment.blank?
                    %br
                    %span.text-info= @closed_shipment['CustomerName'] 
                    %br
                    %span.text-info= @closed_shipment['DateShipped'].to_datetime.in_time_zone(session[:time_zone]).strftime("%l:%M %p") unless @closed_shipment['DateShipped'].blank? or @closed_shipment['DateShipped'] == '{"i:nil"=>"true"}'
                    
          -#
            .col-xs-12
              .panel{style: 'background-color: #303030; color: white;'}
                .panel-heading
                  %h4
                    %i.fa.fa-video-camera
                    Live Camera Feed
                  .embed-responsive.embed-responsive-1by1
                    %iframe{:allow => "autoplay; encrypted-media", :allowfullscreen => "", :frameborder => "0", :height => "1200", :src => "http://192.168.11.54", :width => "854"}
          
        .col-xs-6
          .col-xs-12
            .panel{style: 'background-color: #303030; color: white;'}
              .panel-heading
                %h2 Last 10 Tickets
              - unless @closed_and_held_and_paid_tickets_today.blank?
                %h4.table-responsive
                  %table.table.table-condensed
                    - @closed_and_held_and_paid_tickets_today.sort_by{|t| t['DateCreated']}.reverse.first(10).each do |ticket|
                      %tr
                        %td= ticket['DateCreated'].to_datetime.in_time_zone(session[:time_zone]).strftime("%l:%M %p")
                        %td= ticket['TicketNumber']
                        %td= ticket['Company'].blank? ? "#{ticket['FirstName']} #{ticket['LastName']}" : ticket['Company']
                        %td= Ticket.status_string(ticket['Status'])
                        %td= number_to_currency(ticket['TicketItemCollection'].blank? ? 0 : Ticket.line_items_total(ticket['TicketItemCollection']['ApiTicketItem']))
              - else
                .panel-body None
          .col-xs-12
            .panel{style: 'background-color: #303030; color: white;'}
              .panel-heading
                %h2 Last 10 Shipments
              -# unless @closed_and_held_shipments_today.blank?
              - unless @last_10_shipments.blank?
                %h4.table-responsive
                  %table.table.table-condensed
                    -# @closed_and_held_shipments_today.first(10).each do |shipment|
                    - @last_10_shipments.sort_by{|t| t['DateCreated']}.reverse.each do |shipment|
                      %tr
                        %td= shipment['DateCreated'].to_datetime.in_time_zone(session[:time_zone]).strftime("%l:%M %p")
                        %td= shipment['ShipmentNumber']
                        %td= shipment['CustomerName']
                        %td= shipment['ShipmentStatus'] == '0' ? 'Shipped' : 'Held'
                        %td= "#{number_with_delimiter(shipment['NetWeight'].to_i.round)} lb"
              - else
                .panel-body None
          -#
            .col-xs-12
              .panel{style: 'background-color: #303030; color: white;'}
                .panel-heading
                  %h2
                    %i.fa.fa-bolt
                    ezCash ATMs
                  %h4.table-responsive
                    %table.table.table-condensed
                      %thead
                        %tr
                          %th{:scope => "col"} ID
                          %th{:scope => "col"} Name
                          %th{:scope => "col"} State
                          %th{:scope => "col"} Status
                          %th{:scope => "col"} Remaining
                          %th
                      %tbody
                        %tr
                          %td 312
                          %td Scrapy's ATM
                          %td Ready
                          %td= link_to "1101", '#', class: 'btn btn-sm btn-success'
                          %td= number_to_currency(78084)
    -#
      .row
        .col-xs-12
          .embed-responsive.embed-responsive-16by9
            %iframe{:height => "25", :scrolling => "no", :src => "https://www.dailyforex.com/forex-widget/widget/29566", :style => "width: 100%; height:25px; display: block;border:0px;overflow:hidden;"}
              %span{:style => "position:relative;display:block;text-align:center;color:#ffffff;font-family:verdana,sans-serif;font-size:10px;"}

= render 'shared/ticker_navbar'
=# render 'shared/kpi_footer_navbar'


:javascript
  // Refresh page every 5 minutes
  setInterval(function(){
   window.location.reload(1);
  }, 300000);