= render partial: "shared/navbars/edit_ticket_navbar", locals: {title: @ticket_number, total: number_to_currency(@ticket['BalanceDue'])}

.jumbotron{style: 'background-color: #FFFFFF;'}
  .container
    = form_tag ticket_path, method: 'put', id: 'edit_ticket_form', :class => "form-horizontal" do
      = hidden_field_tag "ticket[ticket_number]", @ticket_number
      = hidden_field_tag "ticket[customer_id]", @ticket["CustomerId"]
      =# hidden_field_tag "ticket[id]", @ticket['Id']
      = hidden_field_tag :drawer_id, @drawers.first['CashDrawerId'] unless @drawers.blank?
      = hidden_field_tag :accounts_payable_id, @accounts_payable_items.last['Id'] unless @accounts_payable_items.blank?
      = render partial: "payment_modal"
      - if @ticket['Status'] == '3'
        .well
          %p
            = "#{payment_method_string(@accounts_payable_items.first['PaymentMethod'])}: #{number_to_currency(@accounts_payable_items.first['PaidAmount'])}"
            - if @accounts_payable_items.first['CheckNumber'].is_a? Integer
              %br
              = "Check Number: #{@accounts_payable_items.first['CheckNumber']}"

      .panel.panel-default
        %div.panel-heading{:role => "tab", id: "vendor_heading"}
          %h4.panel-title
            - if not (@ticket["FirstName"].blank? and @ticket["LastName"].blank?)
              %div.text-success= "#{@ticket['FirstName']} #{@ticket['LastName']}"
            - else
              %div.text-success= "#{@ticket['Company'].blank? ? 'No company name' : @ticket['Company']}"
      - unless @ticket["TicketItemCollection"].blank?
        - unless @ticket["TicketItemCollection"]["ApiTicketItem"].is_a? Hash
          / Multiple ticket line items
          %div.ticket_input_fields_wrap
            #items_accordion.panel-group{"aria-multiselectable" => "true", :role => "tablist"}
              - @line_items.each do |line_item|
                .panel.panel-default.line-item
                  %div.panel-heading{:role => "tab", id: "heading#{line_item['Id']}"}
                    %h4.panel-title
                      %ul{class: 'list-inline'}
                        %li
                          %a.line_item_name.text-success{"aria-controls" => "collapse#{line_item['Id']}", "aria-expanded" => false, "data-parent" => "#items_accordion", "data-toggle" => "collapse", :href => "#collapse_#{line_item['Id']}", :role => "button", class: "collapsed"}
                            = line_item["PrintDescription"]
                        %li.pull-right
                          %a{href: '#', class: 'void_item remove_field', "data-ticket-id" => @ticket['Id'], "data-item-id" => line_item['Id'], "data-commodity-id" => line_item['CommodityId'], "data-gross" => line_item['GrossWeight'], "data-tare" => line_item['TareWeight'], "data-net" => line_item['NetWeight'], "data-price" => line_item['Price'], "data-amount" => line_item['ExtendedAmount']}
                            %i.fa.fa-trash.fa-lg.text-danger
                            %i.fa.fa-spinner.fa-spin.fa-lg.text-danger{style: 'display:none;'}
                  %div{id: "collapse_#{line_item['Id']}", "aria-labelledby" => "heading#{line_item['Id']}", :role => "tabpanel", class: "panel-collapse collapse ", "aria-expanded" => false }
                    .panel-body
                      = hidden_field_tag "ticket[line_items][][id]", line_item['Id']
                      = hidden_field_tag "ticket[line_items][][status]", line_item['Status']
                      = select_tag "ticket[line_items][][commodity]", options_for_select(@commodities.map{ |commodity| [commodity['PrintDescription'], commodity['Id']] }, line_item['CommodityId']), prompt: 'Choose an item', class: "form-control input-lg item_select", required: true
                      %br
                      %div.input-group.gross_input_group
                        - current_user.scale_devices.each do |scale_device|
                          %span.input-group-addon
                            - if scale_device.scale_camera_only?
                              %a{href: '#', style: "color: hotpink;", class: "scale_camera_trigger", id: 'gross_scale_button', 'data-event-code' => "Gross", 'data-ticket-number' => @ticket_number, 'data-item-name' => line_item["PrintDescription"], 'data-yard-id' => current_yard_id, 'data-device-id' => scale_device.id, title: scale_device.DeviceName, 'data-customer-id' => @ticket['CustomerId'] }
                                %i.fa.fa-camera.fa-lg
                                %i.fa.fa-spinner.fa-lg.fa-spin{style: 'display:none;'}
                            - else
                              %a{href: '#', class: "scale_read_and_camera_trigger", id: 'gross_scale_button', 'data-event-code' => "Gross", 'data-ticket-number' => @ticket_number, 'data-item-name' => line_item["PrintDescription"], 'data-yard-id' => current_yard_id, 'data-device-id' => scale_device.id, title: scale_device.DeviceName, 'data-customer-id' => @ticket['CustomerId'] }
                                %i.fa.fa-dashboard.fa-lg
                                %i.fa.fa-spinner.fa-lg.fa-spin{style: 'display:none;'}
                        %span.input-group-addon
                          %i.fa.fa-plus{style: "font-size:0.7em;"}
                        = phone_field_tag "ticket[line_items][][gross]", line_item['GrossWeight'], :placeholder => "Gross", class: "form-control input-lg amount-calculation-field"
                        %span.input-group-addon
                          %a{href: '#', id: 'gross_picture_button', class: 'gross_or_tare_picture_button', 'data-event-code' => "Gross", 'data-weight' => line_item['GrossWeight'], 'data-item-name' => line_item["PrintDescription"], 'data-item-id' => line_item["Id"]}
                            %i.fa.fa-upload.fa-2x
                      %br
                      %div.input-group.tare_input_group
                        - current_user.scale_devices.each do |scale_device|
                          %span.input-group-addon
                            - if scale_device.scale_camera_only?
                              %a{href: '#', style: "color: hotpink;", class: "scale_camera_trigger", id: 'tare_scale_button', 'data-event-code' => "Tare", 'data-ticket-number' => @ticket_number, 'data-item-name' => line_item["PrintDescription"], 'data-yard-id' => current_yard_id, 'data-device-id' => scale_device.id, title: scale_device.DeviceName, 'data-customer-id' => @ticket['CustomerId'] }
                                %i.fa.fa-camera.fa-lg
                                %i.fa.fa-spinner.fa-lg.fa-spin{style: 'display:none;'}
                            - else
                              %a{href: '#', class: "scale_read_and_camera_trigger", id: 'tare_scale_button', 'data-event-code' => "Tare", 'data-ticket-number' => @ticket_number, 'data-item-name' => line_item["PrintDescription"], 'data-yard-id' => current_yard_id, 'data-device-id' => scale_device.id, title: scale_device.DeviceName, 'data-customer-id' => @ticket['CustomerId'] }
                                %i.fa.fa-dashboard.fa-lg
                                %i.fa.fa-spinner.fa-lg.fa-spin{style: 'display:none;'}
                        %span.input-group-addon
                          %i.fa.fa-minus{style: "font-size:0.7em;"}
                        = phone_field_tag "ticket[line_items][][tare]", line_item['TareWeight'], :placeholder => "Tare", class: "form-control input-lg amount-calculation-field tare"
                        %span.input-group-addon
                          %a{href: '#', id: 'tare_picture_button', class: 'gross_or_tare_picture_button', 'data-event-code' => "Tare", 'data-weight' => line_item['TareWeight'], 'data-item-name' => line_item["PrintDescription"], 'data-item-id' => line_item["Id"]}
                            %i.fa.fa-upload.fa-2x
                      %br
                      %div
                        = text_field_tag "ticket[line_items][][net]", line_item['NetWeight'], :placeholder => "Net", class: "form-control input-lg amount-calculation-field", readonly: true
                      %br
                      %div.input-group
                        %span.input-group-addon
                          %i.fa.fa-dollar.fa-lg
                        = text_field_tag "ticket[line_items][][price]", line_item['Price'], :placeholder => "Price", class: "form-control input-lg amount-calculation-field", required: true
                      -#
                        %br
                        %div.input-group
                          %span.input-group-addon
                            %i.fa.fa-dollar.fa-lg
                          = text_field_tag "ticket[line_items][][amount]", line_item['ExtendedAmount'], :placeholder => "Amount", class: "form-control input-lg amount", required: true, readonly: true
                      = hidden_field_tag "ticket[line_items][][amount]", line_item['ExtendedAmount'], :placeholder => "Amount", class: "form-control input-lg amount", required: true, readonly: true
                  .panel-footer
                    %ul{class: 'list-inline'}
                      %li.calculation_details
                        = "(#{line_item['GrossWeight']} - #{line_item['TareWeight']}) = #{line_item['NetWeight']}#{line_item['UnitOfMeasure']}"
                        x
                        = "$#{number_with_precision(line_item['Price'], :precision => 3)}"
                        = "= $#{line_item['ExtendedAmount']}"
                      %li.pull-right
                        %a.text-success{"aria-controls" => "collapse#{line_item['Id']}", "data-toggle" => "collapse", :href => "#collapse_#{line_item['Id']}", class: 'pull-right ticket_collapse_link' }
                          %i.fa.fa-3x.collapse_icon
        - else
          / Only one ticket line item
          %div.ticket_input_fields_wrap
            #items_accordion.panel-group{"aria-multiselectable" => "true", :role => "tablist"}
              .panel.panel-default.line-item
                %div.panel-heading{:role => "tab", id: "heading#{@ticket["TicketItemCollection"]["ApiTicketItem"]['Id']}"}
                  %h4.panel-title
                    %ul{class: 'list-inline'}
                      %li
                        %a.line_item_name.text-success{"aria-controls" => "collapse#{@ticket["TicketItemCollection"]["ApiTicketItem"]['Id']}", "aria-expanded" => false, "data-parent" => "#items_accordion", "data-toggle" => "collapse", :href => "#collapse_#{@ticket["TicketItemCollection"]["ApiTicketItem"]['Id']}", :role => "button", class: "collapsed"}
                          = @ticket["TicketItemCollection"]["ApiTicketItem"]["PrintDescription"]
                      %li.pull-right
                        %a{href: '#', class: 'remove_field'}
                          %i.fa.fa-trash.fa-lg.text-danger
                %div{id: "collapse_#{@ticket["TicketItemCollection"]["ApiTicketItem"]['Id']}", "aria-labelledby" => "heading#{@ticket["TicketItemCollection"]["ApiTicketItem"]['Id']}", :role => "tabpanel", class: "panel-collapse collapse ", "aria-expanded" => false }
                  .panel-body
                    = hidden_field_tag "ticket[line_items][][id]", @ticket["TicketItemCollection"]["ApiTicketItem"]['Id']
                    = hidden_field_tag "ticket[line_items][][status]", @ticket["TicketItemCollection"]["ApiTicketItem"]['Status']
                    = select_tag "ticket[line_items][][commodity]", options_for_select(@commodities.map{ |commodity| [commodity['PrintDescription'], commodity['Id']] }, @ticket["TicketItemCollection"]["ApiTicketItem"]['CommodityId']), prompt: 'Choose an item', class: "form-control input-lg item_select", required: true
                    %br
                    %div.input-group.gross_input_group
                      - current_user.scale_devices.each do |scale_device|
                        %span.input-group-addon
                          - if scale_device.scale_camera_only?
                            %a{href: '#', style: "color: hotpink;", class: "scale_camera_trigger", id: 'gross_scale_button', 'data-event-code' => "Gross", 'data-ticket-number' => @ticket_number, 'data-item-name' => @ticket["TicketItemCollection"]["ApiTicketItem"]["PrintDescription"], 'data-yard-id' => current_yard_id, 'data-device-id' => scale_device.id, title: scale_device.DeviceName, 'data-customer-id' => @ticket['CustomerId'] }
                              %i.fa.fa-camera.fa-lg
                              %i.fa.fa-spinner.fa-lg.fa-spin{style: 'display:none;'}
                          - else
                            %a{href: '#', class: "scale_read_and_camera_trigger", id: 'gross_scale_button', 'data-event-code' => "Gross", 'data-ticket-number' => @ticket_number, 'data-item-name' => @ticket["TicketItemCollection"]["ApiTicketItem"]["PrintDescription"], 'data-yard-id' => current_yard_id, 'data-device-id' => scale_device.id, title: scale_device.DeviceName, 'data-customer-id' => @ticket['CustomerId'] }
                              %i.fa.fa-dashboard.fa-lg
                              %i.fa.fa-spinner.fa-lg.fa-spin{style: 'display:none;'}
                      %span.input-group-addon
                        %i.fa.fa-plus{style: "font-size:0.7em;"}
                      = phone_field_tag "ticket[line_items][][gross]", @ticket["TicketItemCollection"]["ApiTicketItem"]['GrossWeight'], :placeholder => "Gross", class: "form-control input-lg amount-calculation-field"
                      %span.input-group-addon
                        %a{href: '#', id: 'gross_picture_button', class: 'gross_or_tare_picture_button', 'data-event-code' => "Gross", 'data-weight' => @ticket["TicketItemCollection"]["ApiTicketItem"]['GrossWeight'], 'data-item-name' => @ticket["TicketItemCollection"]["ApiTicketItem"]["PrintDescription"], 'data-item-id' => @ticket["TicketItemCollection"]["ApiTicketItem"]["Id"]}
                          %i.fa.fa-upload.fa-2x
                    %br
                    %div.input-group.tare_input_group
                      - current_user.scale_devices.each do |scale_device|
                        %span.input-group-addon
                          - if scale_device.scale_camera_only?
                            %a{href: '#', style: "color: hotpink;", class: "scale_camera_trigger", id: 'tare_scale_button', 'data-event-code' => "Tare", 'data-ticket-number' => @ticket_number, 'data-item-name' => @ticket["TicketItemCollection"]["ApiTicketItem"]["PrintDescription"], 'data-yard-id' => current_yard_id, 'data-device-id' => scale_device.id, title: scale_device.DeviceName, 'data-customer-id' => @ticket['CustomerId'] }
                              %i.fa.fa-camera.fa-lg
                              %i.fa.fa-spinner.fa-lg.fa-spin{style: 'display:none;'}
                          - else
                            %a{href: '#', class: "scale_read_and_camera_trigger", id: 'tare_scale_button', 'data-event-code' => "Tare", 'data-ticket-number' => @ticket_number, 'data-item-name' => @ticket["TicketItemCollection"]["ApiTicketItem"]["PrintDescription"], 'data-yard-id' => current_yard_id, 'data-device-id' => scale_device.id, title: scale_device.DeviceName, 'data-customer-id' => @ticket['CustomerId'] }
                              %i.fa.fa-dashboard.fa-lg
                              %i.fa.fa-spinner.fa-lg.fa-spin{style: 'display:none;'}
                      %span.input-group-addon
                        %i.fa.fa-minus{style: "font-size:0.7em;"}
                      = phone_field_tag "ticket[line_items][][tare]", @ticket["TicketItemCollection"]["ApiTicketItem"]['TareWeight'], :placeholder => "Tare", class: "form-control input-lg amount-calculation-field tare"
                      %span.input-group-addon
                        %a{href: '#', id: 'tare_picture_button', class: 'gross_or_tare_picture_button', 'data-event-code' => "Tare", 'data-weight' => @ticket["TicketItemCollection"]["ApiTicketItem"]['TareWeight'], 'data-item-name' => @ticket["TicketItemCollection"]["ApiTicketItem"]["PrintDescription"], 'data-item-id' => @ticket["TicketItemCollection"]["ApiTicketItem"]["Id"]}
                          %i.fa.fa-upload.fa-2x
                    %br
                    %div
                      = text_field_tag "ticket[line_items][][net]", @ticket["TicketItemCollection"]["ApiTicketItem"]['NetWeight'], :placeholder => "Net", class: "form-control input-lg amount-calculation-field", readonly: true
                    %br
                    %div.input-group
                      %span.input-group-addon
                        %i.fa.fa-dollar.fa-lg
                      = text_field_tag "ticket[line_items][][price]", @ticket["TicketItemCollection"]["ApiTicketItem"]['Price'], :placeholder => "Price", class: "form-control input-lg amount-calculation-field", required: true
                    = hidden_field_tag "ticket[line_items][][amount]", @ticket["TicketItemCollection"]["ApiTicketItem"]['ExtendedAmount'], :placeholder => "Amount", class: "form-control input-lg amount", required: true, readonly: true
                .panel-footer
                  %ul{class: 'list-inline'}
                    %li.calculation_details
                      = "(#{@ticket["TicketItemCollection"]["ApiTicketItem"]['GrossWeight']} - #{@ticket["TicketItemCollection"]["ApiTicketItem"]['TareWeight']}) = #{@ticket["TicketItemCollection"]["ApiTicketItem"]['NetWeight']}#{@ticket["TicketItemCollection"]["ApiTicketItem"]['UnitOfMeasure']}"
                      x
                      = "$#{number_with_precision(@ticket["TicketItemCollection"]["ApiTicketItem"]['Price'], :precision => 3)}"
                      = "= $#{@ticket["TicketItemCollection"]["ApiTicketItem"]['ExtendedAmount']}"
                    %li.pull-right
                      %a.text-success{"aria-controls" => "collapse#{@ticket["TicketItemCollection"]["ApiTicketItem"]['Id']}", "data-toggle" => "collapse", :href => "#collapse_#{@ticket["TicketItemCollection"]["ApiTicketItem"]['Id']}", class: 'pull-right ticket_collapse_link' }
                        %i.fa.fa-3x.collapse_icon
      - else
        / New item
        %div.ticket_input_fields_wrap.new_item
          #items_accordion.panel-group{"aria-multiselectable" => "true", :role => "tablist"}
            .panel.panel-default.line-item
              %div.panel-heading{:role => "tab", id: "heading#{1}"}
                %h4.panel-title
                  %ul{class: 'list-inline'}
                    %li
                      %a.line_item_name.text-success{"aria-controls" => "collapse#{1}", "aria-expanded" => true, "data-toggle" => "collapse", :href => "#collapse_#{1}", :role => "button", class: "ticket_collapse_link" }
                        Choose an item*
                    %li.pull-right
                      %a{href: '#', class: 'remove_field'}
                        %i.fa.fa-trash.fa-lg.text-danger
              %div{id: "collapse_#{1}", "aria-labelledby" => "heading#{1}", :role => "tabpanel", class: "panel-collapse collapse in", "aria-expanded" => true }
                .panel-body
                  = select_tag "ticket[line_items][][commodity]", options_for_select(@commodities.map{ |commodity| [commodity['PrintDescription'], commodity['Id']] }, params[:commodity_id]), prompt: 'Choose an item', class: "form-control input-lg item_select", required: true
                  %br
                  %div.input-group.gross_input_group
                    %span.input-group-addon
                      %i.fa.fa-plus{style: "font-size:0.7em;"}
                    = phone_field_tag "ticket[line_items][][gross]", 0, :placeholder => "Gross", class: "form-control input-lg amount-calculation-field", required: true
                    %span.input-group-addon
                      %a{href: '#', id: 'gross_picture_button', class: 'gross_or_tare_picture_button', 'data-event-code' => "Gross", 'data-weight' => 0}
                        %i.fa.fa-upload.fa-2x
                  %br
                  %div.input-group.tare_input_group
                    %span.input-group-addon
                      %i.fa.fa-minus{style: "font-size:0.7em;"}
                    = phone_field_tag "ticket[line_items][][tare]", 0, :placeholder => "Subtract", class: "form-control input-lg amount-calculation-field tare", required: true
                    %span.input-group-addon
                      %a{href: '#', id: 'tare_picture_button', class: 'gross_or_tare_picture_button', 'data-event-code' => "Tare", 'data-weight' => 0}
                        %i.fa.fa-upload.fa-2x
                  %br
                  = hidden_field_tag "ticket[line_items][][net]", 0, :placeholder => "Net", class: "form-control input-lg amount-calculation-field", required: true, readonly: true
                  %div.input-group
                    %span.input-group-addon
                      %i.fa.fa-dollar.fa-lg
                    = text_field_tag "ticket[line_items][][price]", 0, :placeholder => "Price", class: "form-control input-lg amount-calculation-field", required: true
                  = hidden_field_tag "ticket[line_items][][amount]", 0, :placeholder => "Amount", class: "form-control input-lg amount", required: true, readonly: true
              %div.panel-footer
                %ul{class: 'list-inline'}
                  %li.calculation_details
                  %li.pull-right
                    %a.text-success{"aria-controls" => "collapse#{1}", "data-toggle" => "collapse", :href => "#collapse_#{1}", class: 'pull-right ticket_collapse_link' }
                      %i.fa.fa-check-square.fa-3x.collapse_icon
      
      .row.form-group
        %div.col-xs-3.col-sm-3
          = image_tag("ajax-loader.gif", :id => "spinner", :alt => "Loading ...", style: "display:none;")
          %a{ href: line_item_fields_tickets_path(ticket_number: @ticket_number), 'data-remote' => true, id: "add_item_button", class: "btn btn-warning btn-lg btn-block", onclick: "$(this).hide(); $('#spinner').show();" }
            %i.fa.fa-plus
            = 'Item' unless mobile_device?
        %div.col-xs-3.col-sm-3
          = button_tag(:type => 'submit', :class => 'btn btn-primary btn-lg btn-block', id: 'save_button', name: 'save', data: {disable_with: "<i class='fa fa-spinner fa-spin'></i> Save"}, onclick: "$(this).closest('.form-group').find('#close_and_pay_button').removeAttr('data-disable-with'); $(this).closest('.form-group').find('#close_button').removeAttr('data-disable-with'); $(this).closest('.form-group').find('#pay_button').removeAttr('data-disable-with');") do
            %i.fa.fa-check.fa-lg
            = 'Save'  unless mobile_device?
        %div.col-xs-3.col-sm-3
          - if @ticket['Status'] == '2'
            = button_tag(close_ticket: true, :type => 'submit', :class => 'btn btn-primary btn-lg btn-block', id: 'close_button', name: 'close_ticket', data: {disable_with: "<i class='fa fa-spinner fa-spin'></i> Close"}, autocomplete: "off", onclick: "$(this).closest('.form-group').find('#close_and_pay_button').removeAttr('data-disable-with'); $(this).closest('.form-group').find('#save_button').removeAttr('data-disable-with');") do
              %i.fa.fa-folder.fa-lg
              = 'Close' unless mobile_device?
          - if @ticket['Status'] == '1'
            %a.btn.btn-primary.btn-lg.btn-block{href: "#payment_form", id: 'payment_modal_link', "data-toggle" => "modal", title: "Pay"}
              %i.fa.fa-dollar.fa-lg
              = 'Pay'  unless mobile_device?
            
        - if @ticket['Status'] == '2'
          %div.col-xs-3.col-sm-3
            %a.btn.btn-primary.btn-lg.btn-block{href: "#payment_form", id: 'payment_modal_link', "data-toggle" => "modal", title: "Pay"}
              %i.fa.fa-dollar.fa-lg
              = 'Pay' unless mobile_device?
            
    %hr
    %div#images

    %div{id: 'endless_page'}
      %p= image_tag("ajax-loader.gif", :id => "more_images_spinner", :alt => "Loading ...", style: "display:none;")
      %p= link_to 'More pictures ...', images_path(:page => nil, :q => {ticket_nbr_eq: @ticket_number, yardid_eq: current_yard_id}, :one_image_per_ticket => '0'), :class => 'load-more-images btn btn-default', :remote => true, :onclick => "$(this).hide(); $('#more_images_spinner').show();" 
      %p= link_to 'Re-load pictures ...', images_path(:page => nil, :q => {ticket_nbr_eq: @ticket_number, yardid_eq: current_yard_id}, :one_image_per_ticket => '0'), :class => 'reload-images btn btn-default', :remote => true, :onclick => "$(this).hide(); $('#more_images_spinner').show(); $('#images').empty(); $('a.load-more-images').attr('href', '<%= images_path page: @images.next_page, q: params[:q], one_image_per_ticket: params[:one_image_per_ticket] %>');", style: "display:none;" 
    -#
      .well
        %p= @ticket

= render partial: "shared/ticket_footer_navbar", locals: {title: "Ticket"}